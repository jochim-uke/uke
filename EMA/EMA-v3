<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Medikamenten-Suche – EMA Medicines</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Sehr einfache, neutrale Styles -->
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 1.5rem;
      background: #f7f7f9;
      color: #222;
    }

    h1 {
      margin-bottom: 0.5rem;
    }

    .hint {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 1rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .controls label {
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    input[type="file"],
    input[type="text"],
    select {
      padding: 0.25rem 0.4rem;
      font-size: 0.9rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border-radius: 8px;
      overflow: hidden;
    }

    thead {
      background: #e9ecf3;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    th, td {
      padding: 0.4rem 0.6rem;
      font-size: 0.85rem;
      border-bottom: 1px solid #e2e2e2;
      vertical-align: top;
    }

    th {
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
    }

    tbody tr:hover {
      background: #f2f5ff;
      cursor: pointer;
    }

    .pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    .pagination button {
      padding: 0.25rem 0.6rem;
      font-size: 0.85rem;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
    }

    .pagination button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    #detailPanel {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      font-size: 0.85rem;
      max-height: 260px;
      overflow: auto;
    }

    #detailPanel h2 {
      font-size: 1rem;
      margin-top: 0;
      margin-bottom: 0.3rem;
    }

    #detailPanel dl {
      display: grid;
      grid-template-columns: minmax(120px, 220px) 1fr;
      row-gap: 0.2rem;
      column-gap: 0.75rem;
    }

    #detailPanel dt {
      font-weight: 600;
    }

    #detailPanel dd {
      margin: 0;
    }

    .pill {
      display: inline-block;
      padding: 0.05rem 0.3rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(0,0,0,0.15);
      background: #f5f5f5;
    }

    .pill-green {
      border-color: #4caf50;
      background: #e8f5e9;
      color: #256029;
    }

    .pill-blue {
      border-color: #1976d2;
      background: #e3f2fd;
      color: #0d47a1;
    }

    .muted {
      color: #777;
      font-size: 0.8rem;
    }

    @media (max-width: 800px) {
      .controls {
        flex-direction: column;
        align-items: flex-start;
      }
      #detailPanel dl {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <!-- XLSX.js von CDN (SheetJS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
          integrity="sha512-xv4aX6heV6X9Vt9prelBrWXKkQbf2Hi0dQaTQ1TS3HlbqeFob/kShQhZp0HJE8+idAY1fGV1d2qUc6oeNavq2A=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>

  <h1>Medikamenten-Suche</h1>
  <p class="hint">
    Lade hier die EMA-Medicines-Excel-Datei hoch (z.&nbsp;B. <code>medicines_output_medicines_en-*.xlsx</code>).
    Alle Daten bleiben nur lokal im Browser.
  </p>

  <div class="controls">
    <label>
      Datei:
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
    </label>

    <label>
      Erkrankung:
      <select id="indicationFilter">
        <option value="">Alle Erkrankungen</option>
      </select>
    </label>

    <label>
      Suche:
      <input type="text" id="searchInput" placeholder="Name, INN, Indikation, ATC, MAH …">
    </label>

    <label>
      Zeilen:
      <select id="pageSize">
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="250">250</option>
      </select>
    </label>
  </div>

  <table id="medTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>INN / Wirkstoff</th>
        <th>Indikation</th>
        <th>Therapeutic area</th>
        <th>ATC</th>
        <th>Status / Orphan / PRIME</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <tr>
        <td colspan="6">Lade Daten … (bitte EMA-Excel-Datei wählen)</td>
      </tr>
    </tbody>
  </table>

  <div class="pagination">
    <div>
      <button id="prevPage" disabled>◀︎ Zurück</button>
      <button id="nextPage" disabled>Weiter ▶︎</button>
    </div>
    <div id="pageInfo">Seite 1/1</div>
  </div>

  <section id="detailPanel">
    <div class="muted">Klicke eine Zeile an, um Details zu sehen.</div>
  </section>

  <script>
    // Spaltennamen wie sie in der EMA-Excel-Tabelle vorkommen
    const COL_CATEGORY         = 'Category';
    const COL_NAME             = 'Name of medicine';
    const COL_INN              = 'International non-proprietary name (INN) / common name';
    const COL_INDICATION       = 'Therapeutic indication';
    const COL_TA               = 'Therapeutic area (MeSH)';
    const COL_ATC              = 'ATC code (human)';
    const COL_STATUS           = 'Medicine status';
    const COL_ORPHAN           = 'Orphan medicine';
    const COL_PRIME            = 'PRIME: priority medicine';
    const COL_MAH              = 'Marketing authorisation developer / applicant / holder';
    const COL_AUTH_DATE        = 'Marketing authorisation date';
    const COL_EC_DECISION      = 'European Commission decision date';
    const COL_FIRST_PUB        = 'First published date';
    const COL_LAST_UPDATE      = 'Last updated date';
    const COL_URL              = 'Medicine URL';

    let rawData = [];      // kompletter Datensatz aus der Excel
    let filteredData = []; // nach Suche/Filter
    let currentPage = 1;
    let pageSize = 25;

    const fileInput      = document.getElementById('fileInput');
    const indicationSel  = document.getElementById('indicationFilter');
    const searchInput    = document.getElementById('searchInput');
    const pageSizeSel    = document.getElementById('pageSize');
    const tableBody      = document.getElementById('tableBody');
    const prevBtn        = document.getElementById('prevPage');
    const nextBtn        = document.getElementById('nextPage');
    const pageInfo       = document.getElementById('pageInfo');
    const detailPanel    = document.getElementById('detailPanel');

    fileInput.addEventListener('change', handleFileSelect);
    indicationSel.addEventListener('change', applyFilters);
    searchInput.addEventListener('input', () => {
      currentPage = 1;
      applyFilters();
    });
    pageSizeSel.addEventListener('change', () => {
      pageSize = parseInt(pageSizeSel.value, 10);
      currentPage = 1;
      renderTable();
    });
    prevBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    });
    nextBtn.addEventListener('click', () => {
      const maxPage = Math.max(1, Math.ceil(filteredData.length / pageSize));
      if (currentPage < maxPage) {
        currentPage++;
        renderTable();
      }
    });

    tableBody.addEventListener('click', (ev) => {
      const row = ev.target.closest('tr[data-idx]');
      if (!row) return;
      const idx = parseInt(row.dataset.idx, 10);
      const med = filteredData[idx];
      if (med) {
        renderDetails(med);
      }
    });

    function handleFileSelect(evt) {
      const file = evt.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        // Wir holen erstmal alle Zeilen als Array-of-Arrays
        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        // Headerzeile suchen (erste Spalte == "Category")
        const headerRowIndex = rows.findIndex(r => r && r[0] === COL_CATEGORY);
        if (headerRowIndex === -1) {
          alert('Konnte die Headerzeile (Category / Name of medicine / …) nicht finden.');
          return;
        }

        const header = rows[headerRowIndex];
        const dataRows = rows.slice(headerRowIndex + 1);

        const dataObjs = dataRows
          .map(row => {
            const obj = {};
            header.forEach((colName, colIdx) => {
              if (!colName) return;
              obj[colName] = row[colIdx] !== undefined ? row[colIdx] : null;
            });
            return obj;
          })
          .filter(o => o[COL_NAME]); // leere Zeilen raus

        rawData = dataObjs;
        buildIndicationFilter();
        currentPage = 1;
        applyFilters();
      };
      reader.readAsArrayBuffer(file);
    }

    function buildIndicationFilter() {
      const set = new Set();
      rawData.forEach(row => {
        const ta = (row[COL_TA] || '').toString().trim();
        if (ta) set.add(ta);
      });
      const options = Array.from(set).sort((a, b) => a.localeCompare(b, 'de'));

      // Clear & rebuild
      indicationSel.innerHTML = '<option value=\"\">Alle Erkrankungen</option>';
      options.forEach(ta => {
        const opt = document.createElement('option');
        opt.value = ta;
        opt.textContent = ta;
        indicationSel.appendChild(opt);
      });
    }

    function applyFilters() {
      const taFilter = indicationSel.value;
      const term = searchInput.value.trim().toLowerCase();

      filteredData = rawData.filter(row => {
        // Therapeutic area Filter
        if (taFilter) {
          const ta = (row[COL_TA] || '').toString();
          if (ta !== taFilter) return false;
        }

        // Suchterm Filter
        if (term) {
          const haystack = [
            row[COL_NAME],
            row[COL_INN],
            row[COL_INDICATION],
            row[COL_TA],
            row[COL_ATC],
            row[COL_MAH]
          ].map(x => (x || '').toString().toLowerCase()).join(' | ');

          if (!haystack.includes(term)) return false;
        }

        return true;
      });

      currentPage = 1;
      renderTable();
    }

    function renderTable() {
      tableBody.innerHTML = '';

      if (!filteredData.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 6;
        cell.textContent = rawData.length
          ? 'Keine Treffer für die aktuelle Filter- / Suchkombination.'
          : 'Noch keine Daten geladen. Bitte EMA-Excel-Datei auswählen.';
        row.appendChild(cell);
        tableBody.appendChild(row);

        prevBtn.disabled = true;
        nextBtn.disabled = true;
        pageInfo.textContent = 'Seite 1/1';
        return;
      }

      const maxPage = Math.max(1, Math.ceil(filteredData.length / pageSize));
      if (currentPage > maxPage) currentPage = maxPage;

      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageSlice = filteredData.slice(start, end);

      pageSlice.forEach((row, i) => {
        const globalIdx = start + i;
        const tr = document.createElement('tr');
        tr.dataset.idx = globalIdx;

        const name = (row[COL_NAME] || '').toString();
        const inn  = (row[COL_INN] || '').toString();
        const ind  = (row[COL_INDICATION] || '').toString();
        const ta   = (row[COL_TA] || '').toString();
        const atc  = (row[COL_ATC] || '').toString();
        const status = (row[COL_STATUS] || '').toString();
        const orphan = (row[COL_ORPHAN] || '').toString();
        const prime  = (row[COL_PRIME] || '').toString();

        tr.innerHTML = `
          <td>${escapeHtml(name)}</td>
          <td>${escapeHtml(inn)}</td>
          <td>${escapeHtml(trimTo(ind, 180))}</td>
          <td>${escapeHtml(ta)}</td>
          <td>${escapeHtml(atc)}</td>
          <td>
            <span class="pill">${escapeHtml(status || '–')}</span>
            ${orphan === 'Yes' ? '<span class="pill pill-green">Orphan</span>' : ''}
            ${prime === 'Yes' ? '<span class="pill pill-blue">PRIME</span>' : ''}
          </td>
        `;
        tableBody.appendChild(tr);
      });

      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= maxPage;
      pageInfo.textContent = `Seite ${currentPage}/${maxPage}`;
    }

    function renderDetails(med) {
      const name  = (med[COL_NAME] || '').toString();
      const inn   = (med[COL_INN] || '').toString();
      const ind   = (med[COL_INDICATION] || '').toString();
      const ta    = (med[COL_TA] || '').toString();
      const atc   = (med[COL_ATC] || '').toString();
      const status= (med[COL_STATUS] || '').toString();
      const cat   = (med[COL_CATEGORY] || '').toString();
      const orphan= (med[COL_ORPHAN] || '').toString();
      const prime = (med[COL_PRIME] || '').toString();
      const mah   = (med[COL_MAH] || '').toString();
      const authD = (med[COL_AUTH_DATE] || '').toString();
      const ecD   = (med[COL_EC_DECISION] || '').toString();
      const first = (med[COL_FIRST_PUB] || '').toString();
      const last  = (med[COL_LAST_UPDATE] || '').toString();
      const url   = (med[COL_URL] || '').toString();

      detailPanel.innerHTML = `
        <h2>${escapeHtml(name)}</h2>
        <div class="muted">
          ${cat ? escapeHtml(cat) + ' – ' : ''}${escapeHtml(status || '')}
          ${orphan === 'Yes' ? '<span class="pill pill-green" style="margin-left:0.5rem;">Orphan</span>' : ''}
          ${prime === 'Yes' ? '<span class="pill pill-blue" style="margin-left:0.3rem;">PRIME</span>' : ''}
        </div>
        <p><strong>Indikation:</strong> ${escapeHtml(ind || 'keine Angabe')}</p>
        <dl>
          <dt>INN / Wirkstoff</dt><dd>${escapeHtml(inn || '–')}</dd>
          <dt>Therapeutic area (MeSH)</dt><dd>${escapeHtml(ta || '–')}</dd>
          <dt>ATC (human)</dt><dd>${escapeHtml(atc || '–')}</dd>
          <dt>MAH / Inhaber</dt><dd>${escapeHtml(mah || '–')}</dd>
          <dt>EC decision date</dt><dd>${escapeHtml(ecD || '–')}</dd>
          <dt>Marketing authorisation date</dt><dd>${escapeHtml(authD || '–')}</dd>
          <dt>First published</dt><dd>${escapeHtml(first || '–')}</dd>
          <dt>Last updated</dt><dd>${escapeHtml(last || '–')}</dd>
          <dt>EPAR-Link</dt><dd>${url ? '<a href="' + encodeURI(url) + '" target="_blank" rel="noopener noreferrer">Zur EMA-Seite</a>' : '–'}</dd>
        </dl>
      `;
    }

    function trimTo(str, len) {
      str = str || '';
      if (str.length <= len) return str;
      return str.slice(0, len - 1) + '…';
    }

    function escapeHtml(str) {
      return (str || '').toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  </script>

</body>
</html>