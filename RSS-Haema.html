<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hematology RSS — PubMed Query (Last 60 Days)</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <h1>Hematology PubMed Search</h1>
    <p>One-click: open PubMed with a prebuilt, high-impact hematology trials search limited to the last 60-180 days — then create an RSS feed there.</p>
  </header>

  <main class="container">
    <section class="card">
      <h2>1) PubMed query (copy/edit as you like)</h2>
      <p class="help">This query focuses on hematology (malignant + select benign), clinical trials/randomized/phase language, and high-impact journals. It already limits to the last 60 days, which can be extended if preferred.</p>
      <div class="builder" id="query-builder">
        <div>
          <h3 class="block-title">1) Erkrankungen (Suchterme)</h3>
          <div id="disease-list" class="tokens" role="group" aria-label="Diseases"></div>
          <div class="controls">
            <button id="disease-all" class="secondary" type="button">Alle auswählen</button>
            <button id="disease-none" class="secondary" type="button">Keine</button>
          </div>
        </div>
        <div>
         
          <h3 class="block-title">2) Journals</h3>
         
          <h4 class="block-title">Top Journals</h4>
          <div id="journals-top" class="tokens" role="group" aria-label="Top Journals"></div>
          <div class="controls">
            <button id="journals-top-all" class="secondary" type="button">Alle auswählen</button>
            <button id="journals-top-none" class="secondary" type="button">Keine</button>
          </div>
         
          <h4 class="block-title">Weitere Journale</h4>
          <div id="journals-other" class="tokens" role="group" aria-label="Weitere Journale"></div>
          <div class="controls">
            <button id="journals-other-all" class="secondary" type="button">Alle auswählen</button>
            <button id="journals-other-none" class="secondary" type="button">Keine</button>
          </div>
        </div>
        
        <div>
          <h3 class="block-title">3) Zeitfenster</h3>
          <div class="controls">
            <label for="time-window" class="small">Letzte…</label>
            <select id="time-window">
              <option value="30">30 Tage</option>
              <option value="60" selected>60 Tage</option>
              <option value="90">90 Tage</option>
              <option value="180">180 Tage</option>
              <option value="364">1 Jahr</option>
            </select>
            <span class="small muted">(wird als <code>("last N days"[dp])</code> in den Query eingefügt)</span>
          </div>
        </div>
        <div>
          <h3 class="block-title">4) Studientyp / Publikationstyp</h3>
          <div class="tokens" role="group" aria-label="Studientyp">
            <label class="small">
              <input type="radio" name="study-mode" value="trials_no_meta" checked>
              Klinische Studien (ohne Metaanalysen)
            </label>
            <label class="small">
              <input type="radio" name="study-mode" value="trials_with_meta">
              Klinische Studien + Metaanalysen
            </label>
            <label class="small">
              <input type="radio" name="study-mode" value="reviews">
              Reviews / Metaanalysen
            </label>
            <label class="small">
              <input type="radio" name="study-mode" value="none">
              Kein Filter (alle Publikationstypen)
            </label>
          </div>
        </div>
        <div class="controls">
          <button id="generate" type="button" class="secondary">Query generieren</button>
        </div><br>
      </div>
      <textarea id="pm-query">
/* Der Query wird von der UI oben generiert. Passen Sie ihn bei Bedarf manuell an. */
      </textarea>
      <div class="row">
        <button id="copy-query" class="secondary">Copy query</button>
        <button class="primary" id="open-pubmed"><b>Suche in PubMed ausführen</b></button>
      </div>
      <p id="status" class="small muted"></p>
      <p class="small muted">In PubMed, click <strong>Create alert → RSS</strong> to get a permanent RSS URL for this search.</p>
    </section>

    <section class="card">
      <h2>2) (Optional) Preview an RSS feed here</h2>
      <p class="help">After you create an RSS URL in PubMed, paste it below to preview the latest items on this page. Uses a lightweight public converter (<code>rss2json.com</code>).</p>
      <input id="rss-url" type="text" placeholder="Paste your PubMed RSS URL here…" />
      <div class="row">
        <button id="load-feed">Load feed</button>
      </div>
      <div id="feed" class="feed-list" aria-live="polite"></div>
      <p class="small muted">Note: If your network blocks the converter, GitHub Pages can’t fetch XML cross‑origin. In that case, consider a GitHub Action to fetch & cache JSON at build time.</p>
    </section>

    <section class="card">
      <h2>3) Tips</h2>
      <ul class="small">
        <li>Manuelle Änderungen am Query sind möglich. Klicken Sie dazu einfach in das Textfeld und bearbeiten Sie den Text.</li>
        <li>Um den RSS-Feed  zu nutzen, erstellen Sie in PubMed eine Benachrichtigung (Create alert) und wählen Sie dort die RSS-Option aus.</li>
     
      </ul>
    </section>

    <p class="muted small">
      Dieses Tool nutzt den Drittanbieter-Dienst <a href="https://rss2json.com" target="_blank">rss2json.com</a> zur Umwandlung von RSS in JSON.  
      Alle RSS-Inhalte stammen direkt aus PubMed (NCBI) und unterliegen deren Nutzungsbedingungen.
      </p>

  </main>



  <script>
    const JOURNALS_TOP = [
      { label: 'N Engl J Med', token: '"N Engl J Med"[jour]' },
      { label: 'Lancet', token: '"Lancet"[jour]' },
      { label: 'Lancet Oncol', token: '"Lancet Oncol"[jour]' },
      { label: 'Lancet Haematol', token: '"Lancet Haematol"[jour]' },
      { label: 'JAMA', token: '"JAMA"[jour]' },
      { label: 'JAMA Oncol', token: '"JAMA Oncol"[jour]' },
      { label: 'J Clin Oncol', token: '"J Clin Oncol"[jour]' },
      { label: 'Nat Med', token: '"Nat Med"[jour]' },
      { label: 'Nature', token: '"Nature"[jour]' },
      { label: 'Science', token: '"Science"[jour]' },
      { label: 'Cell', token: '"Cell"[jour]' },
      { label: 'Cancer Cell', token: '"Cancer Cell"[jour]' },
      { label: 'Cancer Discovery', token: '"Cancer Discov"[jour]' },
      { label: 'Clin Cancer Res', token: '"Clin Cancer Res"[jour]' },
      { label: 'Ann Oncol', token: '"Ann Oncol"[jour]' },
      { label: 'Nat Cancer', token: '"Nat Cancer"[jour]' },
      { label: 'Nat Rev Clin Oncol', token: '"Nat Rev Clin Oncol"[jour]' },
      { label: 'Sci Transl Med', token: '"Sci Transl Med"[jour]' },
      { label: 'J Exp Med', token: '"J Exp Med"[jour]' },
      { label: 'Cancer Res', token: '"Cancer Res"[jour]' },
      { label: 'Cancers (Basel)', token: '"Cancers (Basel)"[jour]' },
      { label: 'Blood', token: '"Blood"[jour]' },

    ];

    const JOURNALS_OTHER = [
      { label: 'Blood Adv', token: '"Blood Adv"[jour]' },
      { label: 'HemaSphere', token: '"HemaSphere"[jour]' },
      { label: 'Haematologica', token: '"Haematologica"[jour]' },
      { label: 'Leukemia', token: '"Leukemia"[jour]' },
      { label: 'Am J Hematol', token: '"Am J Hematol"[jour]' },
      { label: 'Br J Haematol', token: '"Br J Haematol"[jour]' },
      { label: 'Eur J Haematol', token: '"Eur J Haematol"[jour]' },
      { label: 'Ann Hematol', token: '"Ann Hematol"[jour]' },
      { label: 'Bone Marrow Transplant', token: '"Bone Marrow Transplant"[jour]' },
      { label: 'J Hematol Oncol', token: '"J Hematol Oncol"[jour]' },
      { label: 'Exp Hematol Oncol', token: '"Exp Hematol Oncol"[jour]' },
      { label: 'Leuk Lymphoma', token: '"Leuk Lymphoma"[jour]' },
      { label: 'Leuk Res', token: '"Leuk Res"[jour]' },
      { label: 'Acta Haematol', token: '"Acta Haematol"[jour]' },
      { label: 'Blood Rev', token: '"Blood Rev"[jour]' },
      { label: 'Blood Cancer J', token: '"Blood Cancer J"[jour]' },
      { label: 'Frontiers in Hematology', token: '"Front Immunol"[jour]' },
      { label: 'J Thromb Haemost', token: '"J Thromb Haemost"[jour]' },
      { label: 'Transplant Cell Ther', token: '"Transplant Cell Ther"[jour]' },
      { label: 'Hematological Oncology', token: '"Hematological Oncology"[jour]' },
      { label: 'Clin Lymphoma Myeloma Leuk', token: '"Clin Lymphoma Myeloma Leuk"[jour]' }

    ];

    const DISEASES = [
      { label: 'AML', tokens: ['"acute myeloid leukemia"[tiab]','AML[tiab]'] },
      { label: 'ALL', tokens: ['"acute lymphoblastic leukemia"[tiab]','ALL[tiab]'] },
      { label: 'CLL', tokens: ['"chronic lymphocytic leukemia"[tiab]','CLL[tiab]'] },
      { label: 'CML', tokens: ['"chronic myeloid leukemia"[tiab]','CML[tiab]'] },
      { label: 'Multiple myeloma', tokens: ['"multiple myeloma"[tiab]','myeloma[tiab]'] },
      { label: 'MDS', tokens: ['"myelodysplastic syndrome"[tiab]','"myelodysplastic syndromes"[tiab]','MDS[tiab]','myelodysplasia[tiab]','"myelodysplastic"[tiab]'] },
      { label: 'MPN', tokens: ['"myeloproliferative neoplasms"[tiab]','"myeloproliferative"[tiab]','MPN[tiab]','"polycythemia vera"[tiab]','"essential thrombocythemia"[tiab]','myelofibrosis[tiab]','pmf[tiab]'] },
      {
  label: 'DLBCL / High-grade B-NHL', tokens: [ 'DLBCL[tiab]','"diffuse large b cell lymphoma"[tiab]', '"diffuse large B-cell lymphoma"[tiab]', '"large b cell lymphoma"[tiab]', '"large b-cell lymphoma"[tiab]', '"high-grade b-cell lymphoma"[tiab]']
},
      { label: 'CNS lymphoma', tokens: ['"central nervous system lymphoma"[tiab]','"cns lymphoma"[tiab]'] },
      { label: 'T-cell lymphoma (broad)', tokens: ['"t-cell lymphoma"[tiab]','"t cell lymphoma"[tiab]','"t-cell lymphomas"[tiab]','"t cell lymphomas"[tiab]'] },
      { label: 'B-Cell lymphoma (broad)', tokens: ['"b cell lymphoma"[tiab]','"bnhl"[tiab]','"non-hodgkin lymphoma"[tiab]']},
      { label: 'Follicular lymphoma', tokens: ['"follicular lymphoma"[tiab]'] },
      { label: 'Mantle cell lymphoma', tokens: ['"mantle cell lymphoma"[tiab]'] },
      { label: 'Marginal zone lymphoma', tokens: ['"marginal zone lymphoma"[tiab]'] },
      { label: 'PTCL/ALCL', tokens: ['"peripheral t-cell lymphoma"[tiab]','PTCL[tiab]','"anaplastic large cell lymphoma"[tiab]','ALCL[tiab]'] },
      { label: 'Burkitt lymphoma', tokens: ['"burkitt lymphoma"[tiab]'] },
      { label: 'PMBCL', tokens: ['"primary mediastinal b-cell lymphoma"[tiab]','PMBCL[tiab]'] },
      { label: 'Hodgkin-Lymphoma', tokens: ['"hodgkin lymphoma"[tiab]','"hodgkin\'s lymphoma"[tiab]','"non-hodgkin\'s lymphoma"[tiab]','NHL[tiab]','"b cell lymphoma"[tiab]'] },
      { label: 'MF/Sezary', tokens: ['"cutaneous t-cell lymphoma"[tiab]','CTCL[tiab]','"sezary syndrome"[tiab]'] },
      { label: 'LPL/Waldenström', tokens: ['"lymphoplasmacytic lymphoma"[tiab]','LPL[tiab]','"waldenstrom macroglobulinemia"[tiab]','"waldenström macroglobulinemia"[tiab]','WM[tiab]'] },
      { label: 'Hairy cell leukemia', tokens: ['"hairy cell leukemia"[tiab]'] },
      { label: 'BPDCN', tokens: ['"blastic plasmacytoid dendritic cell neoplasm"[tiab]','BPDCN[tiab]'] },
      { label: 'Aplastic anemia', tokens: ['"aplastic anemia"[tiab]'] },
      { label: 'PNH', tokens: ['"paroxysmal nocturnal hemoglobinuria"[tiab]','PNH[tiab]'] },
      { label: 'ITP/TTP/HLH', tokens: ['"immune thrombocytopenia"[tiab]','ITP[tiab]','"thrombotic thrombocytopenic purpura"[tiab]','TTP[tiab]','"hemophagocytic lymphohistiocytosis"[tiab]','HLH[tiab]'] },
      { label: 'Sickle cell / Thal / Hemophilia', tokens: ['"sickle cell disease"[tiab]','"sickle cell"[tiab]','thalassemia[tiab]','"hemophilia"[tiab]'] }
    ];

    function renderChecklist(list, containerId) {
      const wrap = document.getElementById(containerId);
      wrap.innerHTML = list.map((item, idx) => {
        const id = `${containerId}_${idx}`;
        return `<label for="${id}"><input type="checkbox" id="${id}" data-idx="${idx}" checked> ${item.label}</label>`;
      }).join('');
    }

    function buildOrBlockFromTokens(groups) {
      // groups: array of arrays (each group is OR-joined internally), then all groups OR-joined together
      const tokens = groups.map(g => g.join(' OR '));
      const orJoined = '  ' + tokens.join(' OR\n  ');
      return `(\n${orJoined}\n)`;
    }

    function setTextareaValue(val) {
      try {
        const wasRO = textarea.hasAttribute('readonly');
        if (wasRO) textarea.removeAttribute('readonly');
        textarea.value = val;
        // also update the underlying node textContent to cover rare Safari repaint issues
        textarea.textContent = val;
        textarea.dispatchEvent(new Event('input', { bubbles: true }));
        if (wasRO) textarea.setAttribute('readonly', '');
      } catch (_) {
        // noop
      }
    }

    function generateQuery() {
      // Diseases selected
      const dWrap = document.getElementById('disease-list');
      const dSelected = Array.from(
        dWrap.querySelectorAll('input[type="checkbox"]:checked')
      ).map(cb => DISEASES[cb.getAttribute('data-idx')].tokens);
      const diseaseBlock = buildOrBlockFromTokens(
        dSelected.length ? dSelected : DISEASES.map(x => x.tokens)
      );

      // Journals selected
      const jTop = Array.from(
        document
          .getElementById('journals-top')
          .querySelectorAll('input[type="checkbox"]:checked')
      ).map(cb => JOURNALS_TOP[cb.getAttribute('data-idx')].token);
      const jOther = Array.from(
        document
          .getElementById('journals-other')
          .querySelectorAll('input[type="checkbox"]:checked')
      ).map(cb => JOURNALS_OTHER[cb.getAttribute('data-idx')].token);
      const journalsTokens =
        jTop.length || jOther.length
          ? [...jTop, ...jOther]
          : [
              ...JOURNALS_TOP.map(j => j.token),
              ...JOURNALS_OTHER.map(j => j.token),
            ];
      const journalsBlock = `(
  ${journalsTokens.join(' OR\n  ')}
)`;

      // Time window
      const days = document.getElementById('time-window').value || '60';
      const dateBlock = `("last ${days} days"[dp])`;

      // Study / publication type modes
      const trialsBlock = `(
  clinical trial[ptyp] OR randomized controlled trial[ptyp] OR
  "phase 1"[tiab] OR "phase I"[tiab] OR
  "phase 2"[tiab] OR "phase II"[tiab] OR
  "phase 3"[tiab] OR "phase III"[tiab] OR
  randomized[tiab] OR randomised[tiab] OR "controlled trial"[tiab] OR
  "first-in-human"[tiab] OR "proof-of-concept"[tiab]
)`;

      const negFilters = [];  // store NOT blocks to append at end

      const modeEl = document.querySelector('input[name="study-mode"]:checked');
      const mode = modeEl ? modeEl.value : 'trials_no_meta';

      const parts = [diseaseBlock];

      if (mode === 'trials_no_meta') {
        parts.push(trialsBlock);
        negFilters.push('(Review[pt] OR Systematic Review[pt] OR Meta-Analysis[pt])');
      } else if (mode === 'trials_with_meta') {
        parts.push(trialsBlock);
        negFilters.push('(Review[pt] OR Systematic Review[pt])');
      } else if (mode === 'reviews') {
        parts.push('(Review[pt] OR Systematic Review[pt] OR Meta-Analysis[pt])');
      } else if (mode === 'none') {
        // no study-type filters
      }

      // Journals + Zeitfenster immer ans Ende der AND-Blöcke
      parts.push(journalsBlock);
      parts.push(dateBlock);

      // Build core query (AND blocks)
      let query = parts.join('\nAND\n');

      // Append NOT blocks at the end — PubMed-safe
      if (negFilters.length > 0) {
        query += '\nNOT ' + negFilters.join(' NOT ');
      }

      setTextareaValue(query);
      status.textContent = 'Query generiert (' + new Date().toLocaleTimeString() + ')';
    }

    const textarea = document.getElementById('pm-query');
    const copyBtn = document.getElementById('copy-query');
    const openBtn = document.getElementById('open-pubmed');
    const status = document.getElementById('status');

    // Render builder UI
    renderChecklist(DISEASES, 'disease-list');
    renderChecklist(JOURNALS_TOP, 'journals-top');
    renderChecklist(JOURNALS_OTHER, 'journals-other');
    // Buttons for disease select-all/none
    document.getElementById('disease-all').onclick = () => { document.querySelectorAll('#disease-list input[type="checkbox"]').forEach(cb => cb.checked = true); };
    document.getElementById('disease-none').onclick = () => { document.querySelectorAll('#disease-list input[type="checkbox"]').forEach(cb => cb.checked = false); };
    // Buttons for journals-top/journals-other select-all/none
    document.getElementById('journals-top-all').onclick = () => { document.querySelectorAll('#journals-top input[type="checkbox"]').forEach(cb => cb.checked = true); generateQuery(); };
    document.getElementById('journals-top-none').onclick = () => { document.querySelectorAll('#journals-top input[type="checkbox"]').forEach(cb => cb.checked = false); generateQuery(); };
    document.getElementById('journals-other-all').onclick = () => { document.querySelectorAll('#journals-other input[type="checkbox"]').forEach(cb => cb.checked = true); generateQuery(); };
    document.getElementById('journals-other-none').onclick = () => { document.querySelectorAll('#journals-other input[type="checkbox"]').forEach(cb => cb.checked = false); generateQuery(); };
    // Generate button
    const genBtn = document.getElementById('generate');
    genBtn.addEventListener('click', (e) => { e.preventDefault(); generateQuery(); });
    // Auto-generate on any change in builder UI
    document.getElementById('disease-list').addEventListener('change', generateQuery);
    document.getElementById('journals-top').addEventListener('change', generateQuery);
    document.getElementById('journals-other').addEventListener('change', generateQuery);
    document.getElementById('time-window').addEventListener('change', generateQuery);
    // Study-mode radio buttons
    document
      .querySelectorAll('input[name="study-mode"]')
      .forEach(el => el.addEventListener('change', generateQuery));
    // Generate once on load
    generateQuery();

    copyBtn.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(textarea.value); copyBtn.textContent = 'Copied!'; setTimeout(()=>copyBtn.textContent='Copy query', 1500); } catch(e) { alert('Copy failed'); }
    });

    function buildPubMedURL(q) {
      const base = 'https://pubmed.ncbi.nlm.nih.gov/';
      // Sanitize: flatten newlines/tabs to single spaces, trim, and collapse multiple spaces
      const term = q.replace(/\s+/g, ' ').trim();
      const params = new URLSearchParams();
      params.set('term', term);
      // Keep newest-first; date window is handled inside the query via [dp]
      params.set('sort', 'date');
      return base + '?' + params.toString();
    }

    openBtn.addEventListener('click', () => {
      const url = buildPubMedURL(textarea.value);
      console.log('PubMed URL:', url);
      window.open(url, '_blank');
    });

    // Lightweight RSS preview using rss2json.com
    const loadBtn = document.getElementById('load-feed');
    const feedUrlInput = document.getElementById('rss-url');
    const feedContainer = document.getElementById('feed');

    async function loadFeed() {
      const u = feedUrlInput.value.trim();
      if (!u) { alert('Please paste a PubMed RSS URL first.'); return; }
      feedContainer.innerHTML = '<p class="muted">Loading…</p>';
      try {
        const api = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(u)}`;
        const res = await fetch(api);
        if (!res.ok) throw new Error('Network error');
        const data = await res.json();
        if (!data.items) throw new Error('No items in feed');
        feedContainer.innerHTML = data.items.slice(0, 12).map(item => {
          const d = new Date(item.pubDate);
          const dateStr = d.toISOString().slice(0,10);
          return `<article class="feed-item">
              <h3><a href="${item.link}" target="_blank" rel="noopener">${item.title}</a></h3>
              <div class="muted">${dateStr}</div>
              <div class="small">${(item.description||'').replace(/<[^>]+>/g, '').slice(0,220)}…</div>
          </article>`;
        }).join('');
      } catch (e) {
        feedContainer.innerHTML = `<p class="muted">Could not load feed. ${e.message}</p>`;
      }
    }

    loadBtn.addEventListener('click', loadFeed);
  </script>
</body>
</html>
