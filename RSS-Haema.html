<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hematology RSS — PubMed Query (Last 60 Days)</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #111a2b;
      --muted: #9bb1d4;
      --text: #e8eefc;
      --accent: #2a7de1;
      --accent-2: #3db0ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    header { padding: 28px 20px; text-align: center; }
    header h1 { margin: 0; font-size: 1.6rem; letter-spacing: 0.3px; }
    header p { margin: 6px 0 0; color: var(--muted); }

    .container { max-width: 980px; margin: 0 auto; padding: 0 16px 48px; }

    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 14px;
      padding: 18px;
      margin: 14px 0 22px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.25);
    }
    .card h2 { margin: 0 0 10px; font-size: 1.1rem; }
    .help { color: var(--muted); font-size: 0.95rem; margin: 6px 0 12px; }

    textarea, input[type="text"] {
      width: 100%; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12);
      background: #0c1424; color: var(--text); padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 0.92rem;
    }
    textarea { min-height: 220px; }

    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button, a.button {
      appearance: none; border: none; cursor: pointer; text-decoration: none; color: white;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      padding: 10px 14px; border-radius: 10px; font-weight: 600; font-size: 0.95rem;
      box-shadow: 0 8px 22px rgba(42,125,225,0.35);
    }
    button.secondary { background: #1b2740; box-shadow: none; color: var(--text); }

    .feed-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; margin-top: 14px; }
    .feed-item { background: #0c1424; border: 1px solid rgba(255,255,255,0.07); border-radius: 10px; padding: 12px; }
    .feed-item h3 { margin: 0 0 6px; font-size: 1rem; }
    .feed-item a { color: #cfe4ff; }
    .muted { color: var(--muted); font-size: 0.85rem; }
    .small { font-size: 0.85rem; }
    footer { color: var(--muted); text-align: center; padding: 24px 0 36px; }
    code { color: #d2e2ff; }

    .builder { display: grid; gap: 12px; }
    .builder .block-title { margin: 0; font-weight: 700; font-size: 0.95rem; color: var(--muted); }
    .tokens { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 8px 12px; }
    .tokens label { display: flex; align-items: center; gap: 8px; background:#0c1424; border:1px solid rgba(255,255,255,0.09); border-radius: 10px; padding: 8px 10px; }
    .tokens input[type="checkbox"] { transform: scale(1.05); }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    select { background:#0c1424; color: var(--text); border:1px solid rgba(255,255,255,0.12); border-radius:10px; padding:8px 10px; }
  </style>
</head>
<body>
  <header>
    <h1>Hematology PubMed RSS (Last 60 Days)</h1>
    <p>One-click: open PubMed with a prebuilt, high-impact hematology trials search limited to the last 60 days — then create an RSS feed there.</p>
  </header>

  <main class="container">
    <section class="card">
      <h2>1) PubMed query (copy/edit as you like)</h2>
      <p class="help">This query focuses on hematology (malignant + select benign), clinical trials/randomized/phase language, and high-impact journals (incl. <em>Bone Marrow Transplantation</em>). It already limits to the last 60 days.</p>
      <div class="builder" id="query-builder">
        <div>
          <h3 class="block-title">1) Erkrankungen (Suchterme)</h3>
          <div id="disease-list" class="tokens" role="group" aria-label="Diseases"></div><br>
          <div class="controls">
            <button id="disease-all" class="secondary" type="button">Alle auswählen</button>
            <button id="disease-none" class="secondary" type="button">Keine</button>
          </div>
        </div>
        <div>
          <h3 class="block-title">2) Journals</h3>
          <div id="journals-list" class="tokens" role="group" aria-label="Journals"></div>
          <div class="controls"><br>
            <button id="journals-all" class="secondary" type="button">Alle auswählen</button>
            <button id="journals-none" class="secondary" type="button">Keine</button>
          </div>
        </div>
        <div>
          <h3 class="block-title">3) Zeitfenster</h3>
          <div class="controls">
            <label for="time-window" class="small">Letzte…</label>
            <select id="time-window">
              <option value="30">30 Tage</option>
              <option value="60" selected>60 Tage</option>
              <option value="90">90 Tage</option>
              <option value="180">180 Tage</option>
            </select>
            <span class="small muted">(wird als <code>("last N days"[dp])</code> in den Query eingefügt)</span>
          </div>
        </div>
        <div class="controls">
          <button id="generate" type="button">Query generieren</button>
        </div><br>
      </div>
      <textarea id="pm-query">
/* Der Query wird von der UI oben generiert. Passen Sie ihn bei Bedarf manuell an. */
      </textarea>
      <div class="row">
        <button id="copy-query">Copy query</button>
        <button class="secondary" id="open-pubmed">Open in PubMed</button>
      </div>
      <p id="status" class="small muted"></p>
      <p class="small muted">In PubMed, click <strong>Create alert → RSS</strong> to get a permanent RSS URL for this search.</p>
    </section>

    <section class="card">
      <h2>2) (Optional) Preview an RSS feed here</h2>
      <p class="help">After you create an RSS URL in PubMed, paste it below to preview the latest items on this page. Uses a lightweight public converter (<code>rss2json.com</code>).</p>
      <input id="rss-url" type="text" placeholder="Paste your PubMed RSS URL here…" />
      <div class="row">
        <button id="load-feed">Load feed</button>
      </div>
      <div id="feed" class="feed-list" aria-live="polite"></div>
      <p class="small muted">Note: If your network blocks the converter, GitHub Pages can’t fetch XML cross‑origin. In that case, consider a GitHub Action to fetch & cache JSON at build time.</p>
    </section>

    <section class="card">
      <h2>3) Tips</h2>
      <ul class="small">
        <li>Adjust the journals in the query’s <code>[jour]</code> block to taste.</li>
        <li>Split into "Lymphoid" vs "Myeloid" by cloning the page and narrowing the disease list.</li>
        <li>Change date window by replacing <code>("last 60 days"[dp])</code> with <code>("last 30 days"[dp])</code>, etc.</li>
      </ul>
    </section>
  </main>

  <footer>
    Built for UKE hematology — static page for GitHub Pages. No cookies, no tracking.
  </footer>

  <script>
    const JOURNALS = [
      { label: 'N Engl J Med', token: '"N Engl J Med"[jour]' },
      { label: 'Lancet', token: '"Lancet"[jour]' },
      { label: 'Lancet Haematol', token: '"Lancet Haematol"[jour]' },
      { label: 'Lancet Oncol', token: '"Lancet Oncol"[jour]' },
      { label: 'J Clin Oncol', token: '"J Clin Oncol"[jour]' },
      { label: 'JAMA Oncol', token: '"JAMA Oncol"[jour]' },
      { label: 'Blood', token: '"Blood"[jour]' },
      { label: 'Blood Adv', token: '"Blood Adv"[jour]' },
      { label: 'Leukemia', token: '"Leukemia"[jour]' },
      { label: 'Haematologica', token: '"Haematologica"[jour]' },
      { label: 'Nat Med', token: '"Nat Med"[jour]' },
      { label: 'Clin Cancer Res', token: '"Clin Cancer Res"[jour]' },
      { label: 'Ann Oncol', token: '"Ann Oncol"[jour]' },
      { label: 'Bone Marrow Transplant', token: '"Bone Marrow Transplant"[jour]' }
    ];

    const DISEASES = [
      { label: 'AML', tokens: ['"acute myeloid leukemia"[tiab]','AML[tiab]'] },
      { label: 'ALL', tokens: ['"acute lymphoblastic leukemia"[tiab]','ALL[tiab]'] },
      { label: 'CLL', tokens: ['"chronic lymphocytic leukemia"[tiab]','CLL[tiab]'] },
      { label: 'CML', tokens: ['"chronic myeloid leukemia"[tiab]','CML[tiab]'] },
      { label: 'Multiple myeloma', tokens: ['"multiple myeloma"[tiab]','myeloma[tiab]'] },
      { label: 'MDS', tokens: ['"myelodysplastic syndrome"[tiab]','"myelodysplastic syndromes"[tiab]','MDS[tiab]','myelodysplasia[tiab]','"myelodysplastic"[tiab]'] },
      { label: 'MPN', tokens: ['"myeloproliferative neoplasms"[tiab]','"myeloproliferative"[tiab]','MPN[tiab]','"polycythemia vera"[tiab]','"essential thrombocythemia"[tiab]','myelofibrosis[tiab]','pmf[tiab]'] },
      {
  label: 'DLBCL / High-grade B-NHL', tokens: [ 'DLBCL[tiab]','"diffuse large b cell lymphoma"[tiab]', '"diffuse large B-cell lymphoma"[tiab]', '"large b cell lymphoma"[tiab]', '"large b-cell lymphoma"[tiab]', '"high-grade b-cell lymphoma"[tiab]']
},
      { label: 'CNS lymphoma', tokens: ['"central nervous system lymphoma"[tiab]','"cns lymphoma"[tiab]'] },
      { label: 'T-cell lymphoma (broad)', tokens: ['"t-cell lymphoma"[tiab]','"t cell lymphoma"[tiab]','"t-cell lymphomas"[tiab]','"t cell lymphomas"[tiab]'] },
      { label: 'B-Cell lymphoma (broad)', tokens: ['"b cell lymphoma"[tiab]','"bnhl"[tiab]','"non-hodgkin lymphoma"[tiab]']},
      { label: 'Follicular lymphoma', tokens: ['"follicular lymphoma"[tiab]'] },
      { label: 'Mantle cell lymphoma', tokens: ['"mantle cell lymphoma"[tiab]'] },
      { label: 'Marginal zone lymphoma', tokens: ['"marginal zone lymphoma"[tiab]'] },
      { label: 'PTCL/ALCL', tokens: ['"peripheral t-cell lymphoma"[tiab]','PTCL[tiab]','"anaplastic large cell lymphoma"[tiab]','ALCL[tiab]'] },
      { label: 'Burkitt lymphoma', tokens: ['"burkitt lymphoma"[tiab]'] },
      { label: 'PMBCL', tokens: ['"primary mediastinal b-cell lymphoma"[tiab]','PMBCL[tiab]'] },
      { label: 'Hodgkin-Lymphoma', tokens: ['"hodgkin lymphoma"[tiab]','"hodgkin\'s lymphoma"[tiab]','"non-hodgkin\'s lymphoma"[tiab]','NHL[tiab]','"b cell lymphoma"[tiab]'] },
      { label: 'MF/Sezary', tokens: ['"cutaneous t-cell lymphoma"[tiab]','CTCL[tiab]','"sezary syndrome"[tiab]'] },
      { label: 'LPL/Waldenström', tokens: ['"lymphoplasmacytic lymphoma"[tiab]','LPL[tiab]','"waldenstrom macroglobulinemia"[tiab]','"waldenström macroglobulinemia"[tiab]','WM[tiab]'] },
      { label: 'Hairy cell leukemia', tokens: ['"hairy cell leukemia"[tiab]'] },
      { label: 'BPDCN', tokens: ['"blastic plasmacytoid dendritic cell neoplasm"[tiab]','BPDCN[tiab]'] },
      { label: 'Aplastic anemia', tokens: ['"aplastic anemia"[tiab]'] },
      { label: 'PNH', tokens: ['"paroxysmal nocturnal hemoglobinuria"[tiab]','PNH[tiab]'] },
      { label: 'ITP/TTP/HLH', tokens: ['"immune thrombocytopenia"[tiab]','ITP[tiab]','"thrombotic thrombocytopenic purpura"[tiab]','TTP[tiab]','"hemophagocytic lymphohistiocytosis"[tiab]','HLH[tiab]'] },
      { label: 'Sickle cell / Thal / Hemophilia', tokens: ['"sickle cell disease"[tiab]','"sickle cell"[tiab]','thalassemia[tiab]','"hemophilia"[tiab]'] }
    ];

    function renderChecklist(list, containerId) {
      const wrap = document.getElementById(containerId);
      wrap.innerHTML = list.map((item, idx) => {
        const id = `${containerId}_${idx}`;
        return `<label for="${id}"><input type="checkbox" id="${id}" data-idx="${idx}" checked> ${item.label}</label>`;
      }).join('');
    }

    function buildOrBlockFromTokens(groups) {
      // groups: array of arrays (each group is OR-joined internally), then all groups OR-joined together
      const tokens = groups.map(g => g.join(' OR '));
      const orJoined = '  ' + tokens.join(' OR\n  ');
      return `(\n${orJoined}\n)`;
    }

    function setTextareaValue(val) {
      try {
        const wasRO = textarea.hasAttribute('readonly');
        if (wasRO) textarea.removeAttribute('readonly');
        textarea.value = val;
        // also update the underlying node textContent to cover rare Safari repaint issues
        textarea.textContent = val;
        textarea.dispatchEvent(new Event('input', { bubbles: true }));
        if (wasRO) textarea.setAttribute('readonly', '');
      } catch (_) {
        // noop
      }
    }

    function generateQuery() {
      // Diseases selected
      const dWrap = document.getElementById('disease-list');
      const dSelected = Array.from(dWrap.querySelectorAll('input[type="checkbox"]:checked')).map(cb => DISEASES[cb.getAttribute('data-idx')].tokens);
      const diseaseBlock = buildOrBlockFromTokens(dSelected.length ? dSelected : DISEASES.map(x => x.tokens));

      // Trials block (fixed)
      const trialsBlock = `(\n  clinical trial[ptyp] OR randomized controlled trial[ptyp] OR\n  "phase 1"[tiab] OR "phase I"[tiab] OR\n  "phase 2"[tiab] OR "phase II"[tiab] OR\n  "phase 3"[tiab] OR "phase III"[tiab] OR\n  randomized[tiab] OR randomised[tiab] OR "controlled trial"[tiab] OR\n  "first-in-human"[tiab] OR "proof-of-concept"[tiab]\n)`;

      // Journals selected
      const jWrap = document.getElementById('journals-list');
      const jSelected = Array.from(jWrap.querySelectorAll('input[type="checkbox"]:checked')).map(cb => JOURNALS[cb.getAttribute('data-idx')].token);
      const journalsTokens = jSelected.length ? jSelected : JOURNALS.map(j => j.token);
      const journalsBlock = `(\n  ${journalsTokens.join(' OR\n  ')}\n)`;

      // Time window
      const days = document.getElementById('time-window').value || '60';
      const dateBlock = `("last ${days} days"[dp])`;

      // Exclude reviews (fixed per your request)
      const excludeReviews = 'NOT (Review[pt] OR Systematic Review[pt] OR Meta-Analysis[pt])';

      const query = `${diseaseBlock}\nAND\n${trialsBlock}\nAND\n${journalsBlock}\n${excludeReviews}\nAND ${dateBlock}`;
      setTextareaValue(query);
      status.textContent = 'Query generiert (' + new Date().toLocaleTimeString() + ')';
    }

    const textarea = document.getElementById('pm-query');
    const copyBtn = document.getElementById('copy-query');
    const openBtn = document.getElementById('open-pubmed');
    const status = document.getElementById('status');

    // Render builder UI
    renderChecklist(DISEASES, 'disease-list');
    renderChecklist(JOURNALS, 'journals-list');
    // Buttons for disease/journal select-all/none
    document.getElementById('disease-all').onclick = () => { document.querySelectorAll('#disease-list input[type="checkbox"]').forEach(cb => cb.checked = true); };
    document.getElementById('disease-none').onclick = () => { document.querySelectorAll('#disease-list input[type="checkbox"]').forEach(cb => cb.checked = false); };
    document.getElementById('journals-all').onclick = () => { document.querySelectorAll('#journals-list input[type="checkbox"]').forEach(cb => cb.checked = true); };
    document.getElementById('journals-none').onclick = () => { document.querySelectorAll('#journals-list input[type="checkbox"]').forEach(cb => cb.checked = false); };
    // Generate button
    const genBtn = document.getElementById('generate');
    genBtn.addEventListener('click', (e) => { e.preventDefault(); generateQuery(); });
    // Auto-generate on any change in builder UI
    document.getElementById('disease-list').addEventListener('change', generateQuery);
    document.getElementById('journals-list').addEventListener('change', generateQuery);
    document.getElementById('time-window').addEventListener('change', generateQuery);
    // Generate once on load
    generateQuery();

    copyBtn.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(textarea.value); copyBtn.textContent = 'Copied!'; setTimeout(()=>copyBtn.textContent='Copy query', 1500); } catch(e) { alert('Copy failed'); }
    });

    function buildPubMedURL(q) {
      const base = 'https://pubmed.ncbi.nlm.nih.gov/';
      // Sanitize: flatten newlines/tabs to single spaces, trim, and collapse multiple spaces
      const term = q.replace(/\s+/g, ' ').trim();
      const params = new URLSearchParams();
      params.set('term', term);
      // Keep newest-first; date window is handled inside the query via [dp]
      params.set('sort', 'date');
      return base + '?' + params.toString();
    }

    openBtn.addEventListener('click', () => {
      const url = buildPubMedURL(textarea.value);
      console.log('PubMed URL:', url);
      window.open(url, '_blank');
    });

    // Lightweight RSS preview using rss2json.com
    const loadBtn = document.getElementById('load-feed');
    const feedUrlInput = document.getElementById('rss-url');
    const feedContainer = document.getElementById('feed');

    async function loadFeed() {
      const u = feedUrlInput.value.trim();
      if (!u) { alert('Please paste a PubMed RSS URL first.'); return; }
      feedContainer.innerHTML = '<p class="muted">Loading…</p>';
      try {
        const api = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(u)}`;
        const res = await fetch(api);
        if (!res.ok) throw new Error('Network error');
        const data = await res.json();
        if (!data.items) throw new Error('No items in feed');
        feedContainer.innerHTML = data.items.slice(0, 12).map(item => {
          const d = new Date(item.pubDate);
          const dateStr = d.toISOString().slice(0,10);
          return `<article class="feed-item">
              <h3><a href="${item.link}" target="_blank" rel="noopener">${item.title}</a></h3>
              <div class="muted">${dateStr}</div>
              <div class="small">${(item.description||'').replace(/<[^>]+>/g, '').slice(0,220)}…</div>
          </article>`;
        }).join('');
      } catch (e) {
        feedContainer.innerHTML = `<p class="muted">Could not load feed. ${e.message}</p>`;
      }
    }

    loadBtn.addEventListener('click', loadFeed);
  </script>
</body>
</html>
